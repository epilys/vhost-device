{
  "tests": [
    {
      "test_name": "staging: build",
      "command": "cd staging && RUSTFLAGS=\"-D warnings\" cargo build -p {{ matrix.package }} --release --all-features --target {target_platform}-unknown-linux-{{ matrix.environment }}",
      "matrix": {
        "setup": {
          "package": [
            "vhost-device-sound",
            "vhost-device-video"
          ],
          "environment": [
            "gnu",
            "musl"
          ]
        },
        "adjustments": [
          {
            "with": {
              "package": "vhost-device-sound",
              "environment": "musl"
            },
            "skip": "true"
          }
        ]
      },
      "soft_fail": "false",
      "platform": [
        "x86_64",
        "aarch64"
      ]
    },
    {
      "test_name": "staging: style",
      "command": "cd staging && cargo fmt --all -- --check --config format_code_in_doc_comments=true"
    },
    {
      "test_name": "staging: unittests",
      "command": "cd staging && cargo test --all-features -p {{ matrix.package }} --target {target_platform}-unknown-linux-{{ matrix.environment }}",
      "matrix": {
        "setup": {
          "package": [
            "vhost-device-sound",
            "vhost-device-video"
          ],
          "environment": [
            "gnu",
            "musl"
          ]
        },
        "adjustments": [
          {
            "with": {
              "package": "vhost-device-sound",
              "environment": "musl"
            },
            "skip": "true"
          },
          {
            "with": {
              "package": "vhost-device-video"
            },
            "soft_fail": "true"
          }
        ]
      },
      "platform": [
        "x86_64",
        "aarch64"
      ]
    },
    {
      "test_name": "staging: clippy",
      "command": "cd staging && cargo clippy --workspace --bins --examples --benches --all-features --all-targets -- -D warnings -D clippy::undocumented_unsafe_blocks",
      "soft_fail": "true",
      "platform": [
        "x86_64",
        "aarch64"
      ]
    },
    {
      "test_name": "staging: check-warnings",
      "command": "cd staging && RUSTFLAGS=\"-D warnings\" cargo check --all-targets --all-features --workspace",
      "soft_fail": "true",
      "platform": [
        "x86_64",
        "aarch64"
      ]
    },
    {
      "test_name": "staging: coverage",
      "command": "cd staging && pytest $(find .. -type f -name \"test_coverage.py\")",
      "soft_fail": "true",
      "docker_plugin": {
        "privileged": true
      },
      "platform": [
        "x86_64"
      ]
    },
    {
      "test_name": "staging: cargo-audit",
      "command": "cd staging && cargo audit -q --deny warnings",
      "soft_fail": "true",
      "platform": [
        "x86_64"
      ]
    }
  ]
}
